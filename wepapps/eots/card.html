<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태양의 제국 에라스무스 카드 앱</title>
    <style>
        body {
            font-family: 'Noto Serif KR', serif;
            background-color: #2b2b2b;
            color: #d4c4a1;
            margin: 0;
            overflow: hidden;
        }
        #main-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        #main-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        #game-container {
            max-width: 1400px;
            margin: auto;
            background: #1c2526;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            position: relative;
            display: none;
        }
        #turn-display {
            font-size: 28px;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        #pass-display {
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
        }
        #inputs {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            background: #3c3f41;
            padding: 10px;
            border-radius: 5px;
        }
        #inputs label {
            font-size: 16px;
        }
        #inputs input[type="number"] {
            width: 60px;
            padding: 5px;
            background: #4b4e50;
            color: #d4c4a1;
            border: 1px solid #6b6e70;
            border-radius: 3px;
        }
        #inputs input[type="checkbox"] {
            transform: scale(1.5);
        }
        #hand {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }
        .card {
            width: 200px;
            height: 300px;
            margin: 5px;
            cursor: pointer;
            border: 2px solid #6b6e70;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
        }
        .enlarged {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 600px;
            z-index: 10;
            border: 3px solid #d4c4a1;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
        }
        .enlarged img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
        }
        .enlarged-buttons {
            position: absolute;
            bottom: -60px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            background: #6b6e70;
            color: #d4c4a1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) {
            background: #8b8e90;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #next-turn {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        #deck-remaining {
            margin-top: 30px;
            font-size: 20px;
            text-align: center;
        }
        #discard-pile {
            margin-top: 10px;
            font-size: 20px;
            text-align: center;
        }
        #discard-hand {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            background: #2f3537;
            padding: 10px;
            border-radius: 5px;
        }
        #future-offensive {
            margin-top: 20px;
            font-size: 20px;
            text-align: center;
            text-transform: uppercase;
        }
        #future-hand {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        #message {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="main-screen">
        <h1>태양의 제국 에라스무스 카드 앱</h1>
        <button id="start-game">게임 시작</button>
    </div>
    <div id="game-container">
        <div id="turn-display" style="display: none;">턴: 1</div>
        <div id="pass-display" style="display: none;">패스: 0</div>
        <div id="message"></div>
        <div id="inputs" style="display: none;">
            <label>자원 헥스: <input type="number" id="resource-hexes" min="0" max="14" value="14"></label>
            <label>잠수함전 성공: <input type="checkbox" id="submarine-success"></label>
            <label>전략 폭격 성공 횟수: <input type="number" id="bombing-successes" min="0" max="2" value="0"></label>
            <button id="draw-cards">카드 뽑기</button>
            <button id="use-pass" disabled>패스 사용</button>
        </div>
        <div id="hand"></div>
        <div id="future-offensive">미래 공세:</div>
        <div id="future-hand"></div>
        <div id="deck-remaining">남은 카드 더미: 20장</div>
        <div id="discard-pile">버린 카드 더미:</div>
        <div id="discard-hand"></div>
        <button id="next-turn" style="display: none;" disabled>다음 턴</button>
    </div>

    <script>
        const numCards = 20; // 일본군 덱 크기
        let deck = [];
        let currentTurn = 1;
        let hand = [];
        let futureOffensive = null;
        let discardPile = [];
        let removedCards = []; // 게임에서 제거된 카드
        let enlargedCard = null;
        let passes = 0;

        // 덱 초기화
        for (let i = 1; i <= numCards; i++) {
            deck.push({ id: `JP Card ${i}`, image: `${i}.gif` });
            // 실제 이미지 사용 시: { id: `JP Card ${i}`, image: `${i}.gif` }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        shuffle(deck);

        const mainScreen = document.getElementById('main-screen');
        const startGameButton = document.getElementById('start-game');
        const gameContainer = document.getElementById('game-container');
        const turnDisplay = document.getElementById('turn-display');
        const passDisplay = document.getElementById('pass-display');
        const inputsDiv = document.getElementById('inputs');
        const drawButton = document.getElementById('draw-cards');
        const usePassButton = document.getElementById('use-pass');
        const handDiv = document.getElementById('hand');
        const futureDiv = document.getElementById('future-offensive');
        const futureHandDiv = document.getElementById('future-hand');
        const deckRemainingDiv = document.getElementById('deck-remaining');
        const discardDiv = document.getElementById('discard-pile');
        const discardHandDiv = document.getElementById('discard-hand');
        const nextTurnButton = document.getElementById('next-turn');
        const messageDiv = document.getElementById('message');

        startGameButton.addEventListener('click', () => {
            mainScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            turnDisplay.style.display = 'block';
            passDisplay.style.display = 'block';
            inputsDiv.style.display = 'flex';
            nextTurnButton.style.display = 'block';
            updateDeckRemainingDisplay();
        });

        drawButton.addEventListener('click', () => {
            const resourceHexes = Math.min(14, parseInt(document.getElementById('resource-hexes').value) || 0);
            const submarineSuccess = document.getElementById('submarine-success').checked ? 1 : 0;
            const bombingSuccesses = parseInt(document.getElementById('bombing-successes').value) || 0;

            let baseCards;
            let finalCardsToDraw;
            let reductions = submarineSuccess + Math.min(2, bombingSuccesses);

            if (currentTurn === 1) {
                baseCards = 2; // 1턴: JP Card 1, JP Card 2만 뽑음
                finalCardsToDraw = 2; // 감소 적용 안 함
            } else if (currentTurn >= 2 && currentTurn <= 4) {
                baseCards = 7; // 2~4턴: 무조건 7장
                finalCardsToDraw = 7; // 감소 적용 안 함
            } else {
                baseCards = Math.max(4, Math.ceil(resourceHexes / 2)); // 자원 헥스 2개당 1장, 최소 4장
                finalCardsToDraw = Math.max(4, baseCards - reductions); // 감소 적용, 최소 4장
            }

            // 디버그 메시지
            messageDiv.textContent = `뽑을 카드: ${finalCardsToDraw} (턴: ${currentTurn}, 기본: ${baseCards}, 잠수함전: ${submarineSuccess}, 폭격: ${bombingSuccesses}, 감소: ${reductions})`;
            setTimeout(() => { messageDiv.textContent = ''; }, 5000);

            // 패스 계산 (미래 공세 카드 제외)
            passes = currentTurn === 1 ? 0 : finalCardsToDraw === 6 ? 1 : finalCardsToDraw <= 5 ? 2 : 0;
            passDisplay.textContent = `패스: ${passes}`;
            usePassButton.disabled = passes === 0;

            // 덱에서 카드 뽑기
            let cardsDrawn = 0;
            if (currentTurn === 1) {
                // 1턴: JP Card 1, JP Card 2만 뽑음
                hand = deck.filter(card => card.id === 'JP Card 1' || card.id === 'JP Card 2');
                deck = deck.filter(card => card.id !== 'JP Card 1' && card.id !== 'JP Card 2');
                cardsDrawn = hand.length;
            } else {
                while (cardsDrawn < finalCardsToDraw) {
                    if (deck.length === 0) {
                        if (discardPile.length === 0) {
                            messageDiv.textContent = `뽑을 카드가 없습니다! (필요: ${finalCardsToDraw - cardsDrawn}장)`;
                            break;
                        }
                        deck = discardPile.slice();
                        discardPile = [];
                        shuffle(deck);
                        messageDiv.textContent = '버린 카드 더미를 섞는 중...';
                        setTimeout(() => { messageDiv.textContent = ''; }, 5000);
                        updateDiscardDisplay();
                    }
                    hand.push(deck.pop());
                    cardsDrawn++;
                }
            }

            updateHandDisplay();
            updateDeckRemainingDisplay();
            drawButton.disabled = true;
            checkNextTurn();
        });

        usePassButton.addEventListener('click', () => {
            if (passes > 0) {
                passes--;
                passDisplay.textContent = `패스: ${passes}`;
                usePassButton.disabled = passes === 0;
                messageDiv.textContent = '패스를 사용했습니다!';
                setTimeout(() => { messageDiv.textContent = ''; }, 3000);
            }
        });

        nextTurnButton.addEventListener('click', () => {
            if (hand.length === 0) {
                currentTurn++;
                turnDisplay.textContent = `턴: ${currentTurn}`;
                drawButton.disabled = false;
                hand = [];
                updateHandDisplay();
                updateDeckRemainingDisplay();
            }
        });

        function createCardElem(card, clickHandler) {
            const cardElem = document.createElement('div');
            cardElem.classList.add('card');
            const img = document.createElement('img');
            img.src = card.image;
            img.alt = card.id;
            img.onerror = () => {
                console.error(`이미지 로드 실패: ${card.image}`);
                messageDiv.textContent = `이미지 로드 실패: ${card.id}`;
                setTimeout(() => { messageDiv.textContent = ''; }, 5000);
            };
            cardElem.appendChild(img);
            if (clickHandler) {
                cardElem.addEventListener('click', clickHandler);
            }
            return cardElem;
        }

        function updateHandDisplay() {
            handDiv.innerHTML = '';
            hand.forEach((card, index) => {
                const cardElem = createCardElem(card, () => enlargeCard(index));
                handDiv.appendChild(cardElem);
            });
        }

        function updateFutureDisplay() {
            futureHandDiv.innerHTML = '';
            if (futureOffensive) {
                const cardElem = createCardElem(futureOffensive, enlargeFutureCard);
                futureHandDiv.appendChild(cardElem);
            }
        }

        function updateDeckRemainingDisplay() {
            deckRemainingDiv.textContent = `남은 카드 더미: ${deck.length}장`;
        }

        function updateDiscardDisplay() {
            discardHandDiv.innerHTML = '';
            discardPile.forEach((card) => {
                const cardElem = createCardElem(card, null);
                discardHandDiv.appendChild(cardElem);
            });
        }

        function enlargeCard(index) {
            if (enlargedCard) return;

            const card = hand[index];
            enlargedCard = document.createElement('div');
            enlargedCard.classList.add('enlarged');
            const img = document.createElement('img');
            img.src = card.image.replace(/200x300\?text=JP(\d+)/, '400x600?text=JP$1');
            // 실제 이미지 사용 시: img.src = card.image.replace('.gif', '_large.gif');
            img.alt = card.id;
            img.onerror = () => {
                console.error(`확대 이미지 로드 실패: ${img.src}`);
                messageDiv.textContent = `확대 이미지 로드 실패: ${card.id}`;
                setTimeout(() => { messageDiv.textContent = ''; }, 5000);
            };
            enlargedCard.appendChild(img);

            const buttonDiv = document.createElement('div');
            buttonDiv.classList.add('enlarged-buttons');

            if (card.id === 'JP Card 1' || card.id === 'JP Card 2') {
                // JP Card 1, 2: 게임에서 제거 버튼만 표시
                const removeButton = document.createElement('button');
                removeButton.textContent = '게임에서 제거 (3)';
                removeButton.addEventListener('click', () => {
                    removedCards.push(hand.splice(index, 1)[0]);
                    closeEnlarged();
                    updateHandDisplay();
                    updateDeckRemainingDisplay();
                    checkNextTurn();
                });
                buttonDiv.appendChild(removeButton);

                // 키보드 이벤트: 3번만 동작
                const handleKeyPress = (e) => {
                    if (e.key === '3') {
                        removeButton.click();
                    }
                };
                document.addEventListener('keydown', handleKeyPress);

                // 클로저
                enlargedCard.close = () => {
                    document.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('click', closeEnlargedOutside);
                    enlargedCard.remove();
                    enlargedCard = null;
                };
            } else {
                // 다른 카드: 기존 버튼 모두 표시
                const useButton = document.createElement('button');
                useButton.textContent = '사용 (1)';
                useButton.addEventListener('click', () => {
                    discardPile.push(hand.splice(index, 1)[0]);
                    updateDiscardDisplay();
                    closeEnlarged();
                    updateHandDisplay();
                    updateDeckRemainingDisplay();
                    checkNextTurn();
                });

                const futureButton = document.createElement('button');
                futureButton.textContent = '미래 공세 (2)';
                futureButton.disabled = !!futureOffensive || ['JP Card 19', 'JP Card 20'].includes(card.id);
                futureButton.addEventListener('click', () => {
                    if (!futureOffensive) {
                        futureOffensive = hand.splice(index, 1)[0];
                        updateFutureDisplay();
                        closeEnlarged();
                        updateHandDisplay();
                        updateDeckRemainingDisplay();
                        checkNextTurn();
                    }
                });

                const removeButton = document.createElement('button');
                removeButton.textContent = '게임에서 제거 (3)';
                removeButton.addEventListener('click', () => {
                    removedCards.push(hand.splice(index, 1)[0]);
                    closeEnlarged();
                    updateHandDisplay();
                    updateDeckRemainingDisplay();
                    checkNextTurn();
                });

                buttonDiv.appendChild(useButton);
                buttonDiv.appendChild(futureButton);
                buttonDiv.appendChild(removeButton);

                // 키보드 이벤트: 1, 2, 3번 동작
                const handleKeyPress = (e) => {
                    if (e.key === '1') {
                        useButton.click();
                    } else if (e.key === '2' && !futureButton.disabled) {
                        futureButton.click();
                    } else if (e.key === '3') {
                        removeButton.click();
                    }
                };
                document.addEventListener('keydown', handleKeyPress);

                // 클로저
                enlargedCard.close = () => {
                    document.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('click', closeEnlargedOutside);
                    enlargedCard.remove();
                    enlargedCard = null;
                };
            }

            enlargedCard.appendChild(buttonDiv);
            document.body.appendChild(enlargedCard);

            // 확대된 카드 닫기
            setTimeout(() => {
                document.addEventListener('click', closeEnlargedOutside);
            }, 0);
        }

        function enlargeFutureCard() {
            if (enlargedCard) return;

            const card = futureOffensive;
            enlargedCard = document.createElement('div');
            enlargedCard.classList.add('enlarged');
            const img = document.createElement('img');
            img.src = card.image.replace(/200x300\?text=JP(\d+)/, '400x600?text=JP$1');
            // 실제 이미지 사용 시: img.src = card.image.replace('.gif', '_large.gif');
            img.alt = card.id;
            img.onerror = () => {
                console.error(`확대 이미지 로드 실패: ${img.src}`);
                messageDiv.textContent = `확대 이미지 로드 실패: ${card.id}`;
                setTimeout(() => { messageDiv.textContent = ''; }, 5000);
            };
            enlargedCard.appendChild(img);

            const buttonDiv = document.createElement('div');
            buttonDiv.classList.add('enlarged-buttons');

            const useButton = document.createElement('button');
            useButton.textContent = '사용 (1)';
            useButton.addEventListener('click', () => {
                discardPile.push(futureOffensive);
                futureOffensive = null;
                updateFutureDisplay();
                updateDiscardDisplay();
                closeEnlarged();
                updateDeckRemainingDisplay();
                checkNextTurn();
            });

            buttonDiv.appendChild(useButton);
            enlargedCard.appendChild(buttonDiv);
            document.body.appendChild(enlargedCard);

            // 키보드 이벤트 추가
            const handleKeyPress = (e) => {
                if (e.key === '1') {
                    useButton.click();
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            // 확대된 카드 닫기
            setTimeout(() => {
                document.addEventListener('click', closeEnlargedOutside);
            }, 0);

            // 키보드 이벤트 제거를 위한 클로저
            enlargedCard.close = () => {
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('click', closeEnlargedOutside);
                enlargedCard.remove();
                enlargedCard = null;
            };
        }

        function closeEnlarged() {
            if (enlargedCard) {
                enlargedCard.close();
            }
        }

        function closeEnlargedOutside(e) {
            if (!enlargedCard.contains(e.target)) {
                closeEnlarged();
            }
        }

        function checkNextTurn() {
            nextTurnButton.disabled = hand.length > 0;
        }

        updateFutureDisplay();
        updateDeckRemainingDisplay();
    </script>
</body>
</html>