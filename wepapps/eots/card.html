<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태양의 제국 에라스무스 카드 앱</title>
    <style>
        body {
            font-family: 'Noto Serif KR', serif;
            background-color: #2b2b2b;
            color: #d4c4a1;
            margin: 0;
            overflow: auto;
        }
        #main-screen {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100%;
        }
        #main-image {
            height: 100vh;
            width: auto;
            overflow: hidden;
        }
        #main-image img {
            height: 100%;
            width: auto;
            object-fit: contain;
            object-position: left;
            display: block;
            z-index: 0;
        }
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #2b2b2b;
            text-align: center;
        }
        #main-content h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
            white-space: pre-line;
            line-height: 1.2;
        }
        #start-game {
            padding: 10px 20px;
            background: #6b6e70;
            color: #d4c4a1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            transition: background 0.2s, transform 0.1s;
        }
        #start-game:hover {
            background: #8b8e90;
        }
        #start-game:active {
            background: #5b5e60;
            transform: scale(0.95);
        }
        #game-container {
            max-width: 1400px;
            margin: auto;
            background: #1c2526;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            position: relative;
            display: none;
            min-height: 100vh;
        }
        #control-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        #tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #6b6e70;
            color: #d4c4a1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            text-transform: uppercase;
            transition: background 0.2s, transform 0.1s;
            min-width: 100px;
            box-sizing: border-box;
        }
        .tab:hover {
            background: #8b8e90;
        }
        .tab.active {
            background: #d4c4a1;
            color: #2b2b2b;
        }
        .tab:active:not(.active) {
            background: #5b5e60;
            transform: scale(0.95);
        }
        #turn-display {
            font-size: 28px;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        #pass-display {
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
        }
        #inputs, #allied-inputs {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            background: #3c3f41;
            padding: 10px;
            border-radius: 5px;
        }
        #inputs label, #allied-inputs label {
            font-size: 16px;
        }
        #inputs input[type="number"], #allied-inputs input[type="number"] {
            width: 50px;
            font-size: 18px;
            padding: 4px;
            background: #4b4e50;
            color: #d4c4a1;
            border: 1px solid #6b6e70;
            border-radius: 3px;
        }
        #inputs input[type="checkbox"], #allied-inputs input[type="checkbox"] {
            transform: scale(1.5);
        }
        #allied-inputs .surrender-checkbox {
            display: inline-block;
            margin-right: 10px;
        }
        #hand {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }
        .card {
            width: 200px;
            height: 300px;
            margin: 5px;
            cursor: pointer;
            border: 2px solid #6b6e70;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            position: relative;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
            display: none;
        }
        .card img.loaded {
            display: block;
        }
        .enlarged {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 600px;
            z-index: 30;
            border: 3px solid #d4c4a1;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
            transition: none;
        }
        .enlarged img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            display: none;
        }
        .enlarged img.loaded {
            display: block;
        }
        .enlarged-buttons {
            position: absolute;
            bottom: -60px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            background: #6b6e70;
            color: #d4c4a1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            transition: background 0.2s, transform 0.1s;
            min-width: 100px;
            box-sizing: border-box;
        }
        button:active:not(:disabled) {
            background: #5b5e60;
            transform: scale(0.95);
        }
        button:hover:not(:disabled) {
            background: #8b8e90;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #next-turn, #undo-button, #restart-button {
            margin: 5px;
        }
        #deck-remaining {
            margin-top: 30px;
            font-size: 20px;
            text-align: center;
        }
        #discard-pile, #removed-pile {
            margin-top: 10px;
            font-size: 20px;
            text-align: center;
            cursor: pointer;
            transition: color 0.2s;
        }
        #discard-pile:hover, #removed-pile:hover {
            color: #ffffff;
        }
        #discard-hand {
            display: none;
        }
        #discard-modal, #removed-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 20;
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            text-align: center;
        }
        #discard-modal-content, #removed-modal-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            background: #2f3537;
            border-radius: 5px;
        }
        #discard-modal-close, #removed-modal-close {
            margin-top: 10px;
            padding: 10px 20px;
            background: #ff6b6b;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        #discard-modal-close:hover, #removed-modal-close:hover {
            background: #ff8b8b;
        }
        #discard-modal-close:active, #removed-modal-close:active {
            background: #e55b5b;
            transform: scale(0.95);
        }
        #future-offensive {
            margin-top: 20px;
            font-size: 20px;
            text-align: center;
            text-transform: uppercase;
        }
        #future-hand {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        #message {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        #turn-modal, #game-over-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #d4c4a1;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 24px;
            z-index: 20;
            text-align: center;
            animation: fadeOut 3s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        .placeholder {
            width: 100%;
            height: 100%;
            background: #4b4e50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d4c4a1;
            font-size: 16px;
            text-align: center;
            border-radius: 3px;
        }
        /* 모바일 반응형 스타일 */
        @media (max-width: 768px) {
            #main-screen {
                flex-direction: column;
                height: auto;
            }
            #main-image {
                width: 100%;
                height: auto;
            }
            #main-image img {
                width: 100%;
                height: auto;
                object-fit: contain;
                object-position: center;
            }
            #main-content {
                width: 100%;
                padding: 20px;
            }
            #main-content h1 {
                font-size: 32px;
                margin: 10px 0;
            }
            #start-game {
                font-size: 16px;
                padding: 8px 16px;
            }
            #game-container {
                padding: 10px;
            }
            #control-buttons {
                flex-direction: column;
                align-items: center;
            }
            #tabs {
                flex-direction: column;
                align-items: center;
            }
            .tab {
                font-size: 16px;
                padding: 8px 16px;
                width: 100%;
                max-width: 200px;
            }
            #inputs, #allied-inputs {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            #inputs button, #allied-inputs button {
                font-size: 14px;
                padding: 8px 16px;
                width: 100%;
                max-width: 200px;
            }
            #next-turn, #undo-button, #restart-button {
                font-size: 14px;
                padding: 8px 16px;
                width: 100%;
                max-width: 200px;
            }
            #discard-modal, #removed-modal {
                width: 90%;
                max-width: 600px;
            }
            #discard-modal-close, #removed-modal-close {
                font-size: 14px;
                padding: 8px 16px;
                width: 100%;
                max-width: 200px;
            }
            .enlarged {
                width: 80%;
                height: auto;
                max-height: 70vh;
            }
            .enlarged img {
                width: 100%;
                height: auto;
                object-fit: contain;
            }
            .enlarged-buttons {
                bottom: -50px;
                gap: 8px;
            }
            .enlarged-buttons button {
                font-size: 14px;
                padding: 8px 12px;
                min-width: 80px;
            }
            .card {
                width: 150px;
                height: 225px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="main-screen">
        <div id="main-image">
            <img src="card_image/eots.jpg" alt="태양의 제국 이미지">
        </div>
        <div id="main-content">
            <h1>태양의 제국<br>에라스무스 카드 앱</h1>
            <button id="start-game">게임 시작</button>
        </div>
    </div>
    <div id="game-container">
        <div id="control-buttons">
            <button id="restart-button" style="display: none;">다시 시작</button>
            <button id="undo-button" style="display: none;" disabled>이전</button>
            <button id="next-turn" style="display: none;" disabled>다음 턴</button>
        </div>
        <div id="tabs">
            <button id="allied-tab" class="tab">연합군</button>
            <button id="japanese-tab" class="tab active">일본군</button>
        </div>
        <div id="faction-content">
            <div id="turn-display" style="display: none;">턴: 1</div>
            <div id="pass-display" style="display: none;">패스: 0</div>
            <div id="message"></div>
            <div id="inputs" style="display: none;">
                <label>자원 헥스: <input type="number" id="resource-hexes" min="0" max="14" value="14"></label>
                <label>잠수함전 성공: <input type="checkbox" id="submarine-success"></label>
                <label>전략 폭격 성공 횟수: <input type="number" id="bombing-successes" min="0" max="2" value="0"></label>
                <button id="japanese-draw-cards">카드 뽑기</button>
                <button id="japanese-use-pass" disabled>패스 사용</button>
            </div>
            <div id="allied-inputs" style="display: none;">
                <label>유럽 전쟁 레벨: <input type="number" id="wie-level" min="0" max="4" value="0"></label>
                <div class="surrender-checkbox">
                    <label>중국 항복: <input type="checkbox" id="china-surrender"></label>
                </div>
                <div class="surrender-checkbox">
                    <label>인도 항복: <input type="checkbox" id="india-surrender"></label>
                </div>
                <div class="surrender-checkbox">
                    <label>호주 항복: <input type="checkbox" id="australia-surrender"></label>
                </div>
                <button id="allied-draw-cards">카드 뽑기</button>
                <button id="allied-use-pass" disabled>패스 사용</button>
            </div>
            <div id="hand"></div>
            <div id="future-offensive">미래 공세:</div>
            <div id="future-hand"></div>
            <div id="deck-remaining">남은 카드 더미: 20장</div>
            <div id="discard-pile">버린 카드 더미:</div>
            <div id="removed-pile">제거된 카드 더미:</div>
            <div id="discard-hand"></div>
            <div id="turn-modal"></div>
            <div id="game-over-modal"></div>
            <div id="discard-modal">
                <div id="discard-modal-content"></div>
                <button id="discard-modal-close">닫기</button>
            </div>
            <div id="removed-modal">
                <div id="removed-modal-content"></div>
                <button id="removed-modal-close">닫기</button>
            </div>
        </div>
    </div>

    <script>
        const numCards = 20;
        const imageExtensions = ['.png'];
        const placeholderImage = 'card_image/placeholder.png';
        let factions = {
            allied: { deck: [], hand: [], futureOffensive: null, discardPile: [], removedCards: [], currentTurn: 1, passes: 0, stateHistory: [] },
            japanese: { deck: [], hand: [], futureOffensive: null, discardPile: [], removedCards: [], currentTurn: 1, passes: 0, stateHistory: [] }
        };
        let currentFaction = 'japanese';
        let enlargedCard = null;

        function getValidImagePath(basePath, cardNumber, isLarge = false) {
            return `${basePath}/${cardNumber}${isLarge ? '_large' : ''}${imageExtensions[0]}`;
        }

        function initializeDeck(faction) {
            const deck = [];
            const path = faction === 'allied' ? 'card_image/al' : 'card_image/jp';
            for (let i = 1; i <= numCards; i++) {
                const imagePath = getValidImagePath(path, i);
                deck.push({ id: `${faction === 'allied' ? 'AL Card' : 'JP Card'} ${i}`, image: imagePath });
            }
            shuffle(deck);
            return deck;
        }

        factions.allied.deck = initializeDeck('allied');
        factions.japanese.deck = initializeDeck('japanese');

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function saveState() {
            const faction = factions[currentFaction];
            faction.stateHistory.push({
                deck: [...faction.deck],
                hand: [...faction.hand],
                discardPile: [...faction.discardPile],
                removedCards: [...faction.removedCards],
                futureOffensive: faction.futureOffensive ? { ...faction.futureOffensive } : null,
                currentTurn: faction.currentTurn,
                passes: faction.passes
            });
            undoButton.disabled = false;
        }

        function undo() {
            const faction = factions[currentFaction];
            if (faction.stateHistory.length === 0) return;

            const lastState = faction.stateHistory.pop();
            faction.deck = [...lastState.deck];
            faction.hand = [...lastState.hand];
            faction.discardPile = [...lastState.discardPile];
            faction.removedCards = [...lastState.removedCards];
            faction.futureOffensive = lastState.futureOffensive ? { ...lastState.futureOffensive } : null;
            faction.currentTurn = lastState.currentTurn;
            faction.passes = lastState.passes;

            updateUI();
            messageDiv.textContent = '작업이 취소되었습니다!';
            setTimeout(() => { messageDiv.textContent = ''; }, 3000);
        }

        function resetGame() {
            factions.allied = { deck: initializeDeck('allied'), hand: [], futureOffensive: null, discardPile: [], removedCards: [], currentTurn: 1, passes: 0, stateHistory: [] };
            factions.japanese = { deck: initializeDeck('japanese'), hand: [], futureOffensive: null, discardPile: [], removedCards: [], currentTurn: 1, passes: 0, stateHistory: [] };
            updateUI();
            gameContainer.style.display = 'none';
            mainScreen.style.display = 'flex';
            discardModal.style.display = 'none';
            removedModal.style.display = 'none';
        }

        const mainScreen = document.getElementById('main-screen');
        const startGameButton = document.getElementById('start-game');
        const gameContainer = document.getElementById('game-container');
        const alliedTab = document.getElementById('allied-tab');
        const japaneseTab = document.getElementById('japanese-tab');
        const turnDisplay = document.getElementById('turn-display');
        const passDisplay = document.getElementById('pass-display');
        const inputsDiv = document.getElementById('inputs');
        const alliedInputs = document.getElementById('allied-inputs');
        const alliedDrawButton = document.getElementById('allied-draw-cards');
        const japaneseDrawButton = document.getElementById('japanese-draw-cards');
        const alliedUsePassButton = document.getElementById('allied-use-pass');
        const japaneseUsePassButton = document.getElementById('japanese-use-pass');
        const handDiv = document.getElementById('hand');
        const futureDiv = document.getElementById('future-offensive');
        const futureHandDiv = document.getElementById('future-hand');
        const deckRemainingDiv = document.getElementById('deck-remaining');
        const discardPileDiv = document.getElementById('discard-pile');
        const removedPileDiv = document.getElementById('removed-pile');
        const discardHandDiv = document.getElementById('discard-hand');
        const nextTurnButton = document.getElementById('next-turn');
        const undoButton = document.getElementById('undo-button');
        const restartButton = document.getElementById('restart-button');
        const messageDiv = document.getElementById('message');
        const turnModal = document.getElementById('turn-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const discardModal = document.getElementById('discard-modal');
        const discardModalContent = document.getElementById('discard-modal-content');
        const discardModalClose = document.getElementById('discard-modal-close');
        const removedModal = document.getElementById('removed-modal');
        const removedModalContent = document.getElementById('removed-modal-content');
        const removedModalClose = document.getElementById('removed-modal-close');

        startGameButton.addEventListener('click', () => {
            mainScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            turnDisplay.style.display = 'block';
            passDisplay.style.display = 'block';
            inputsDiv.style.display = currentFaction === 'japanese' ? 'flex' : 'none';
            alliedInputs.style.display = currentFaction === 'allied' ? 'flex' : 'none';
            nextTurnButton.style.display = 'block';
            undoButton.style.display = 'block';
            restartButton.style.display = 'block';
            updateUI();
        });

        alliedTab.addEventListener('click', () => switchFaction('allied'));
        japaneseTab.addEventListener('click', () => switchFaction('japanese'));

        function switchFaction(faction) {
            if (currentFaction !== faction) {
                currentFaction = faction;
                alliedTab.classList.toggle('active', faction === 'allied');
                japaneseTab.classList.toggle('active', faction === 'japanese');
                inputsDiv.style.display = faction === 'japanese' ? 'flex' : 'none';
                alliedInputs.style.display = faction === 'allied' ? 'flex' : 'none';
                updateUI();
            }
        }

        function updateUI() {
            const faction = factions[currentFaction];
            turnDisplay.textContent = `턴: ${faction.currentTurn}`;
            passDisplay.textContent = `패스: ${faction.passes}`;
            alliedUsePassButton.disabled = faction.passes === 0;
            japaneseUsePassButton.disabled = faction.passes === 0;
            alliedDrawButton.disabled = faction.hand.length > 0 || (currentFaction === 'allied' && faction.currentTurn === 1);
            japaneseDrawButton.disabled = faction.hand.length > 0 && currentFaction === 'japanese';
            nextTurnButton.disabled = faction.hand.length > 0;
            undoButton.disabled = faction.stateHistory.length === 0;

            if (currentFaction === 'allied' && faction.currentTurn === 1) {
                messageDiv.textContent = '연합군은 1턴에 카드를 뽑지 않습니다';
            } else {
                messageDiv.textContent = '';
            }

            updateHandDisplay();
            updateFutureDisplay();
            updateDiscardModal();
            updateRemovedModal();
            updateDeckRemainingDisplay();
            discardModal.style.display = 'none';
            removedModal.style.display = 'none';
        }

        discardPileDiv.addEventListener('click', () => {
            discardModal.style.display = 'block';
            updateDiscardModal();
        });

        discardModalClose.addEventListener('click', () => {
            discardModal.style.display = 'none';
        });

        discardModal.addEventListener('click', (e) => {
            if (e.target === discardModal) {
                discardModal.style.display = 'none';
            }
        });

        removedPileDiv.addEventListener('click', () => {
            removedModal.style.display = 'block';
            updateRemovedModal();
        });

        removedModalClose.addEventListener('click', () => {
            removedModal.style.display = 'none';
        });

        removedModal.addEventListener('click', (e) => {
            if (e.target === removedModal) {
                removedModal.style.display = 'none';
            }
        });

        function drawCards(factionType) {
            saveState();
            const faction = factions[factionType];
            let baseCards = 0;
            let finalCardsToDraw = 0;
            let basePasses = 0;
            let reductions = 0;
            let additionalPasses = 0;

            if (factionType === 'allied') {
                if (faction.currentTurn === 1) {
                    baseCards = 0;
                    basePasses = 0;
                } else if (faction.currentTurn === 2) {
                    baseCards = 5;
                    basePasses = 2;
                } else if (faction.currentTurn === 3) {
                    baseCards = 6;
                    basePasses = 1;
                } else {
                    baseCards = 7;
                    basePasses = 0;
                }

                const wieLevel = parseInt(document.getElementById('wie-level').value) || 0;
                reductions = (wieLevel === 4 ? 1 : 0) +
                            (document.getElementById('china-surrender').checked ? 1 : 0) +
                            (document.getElementById('india-surrender').checked ? 1 : 0) +
                            (document.getElementById('australia-surrender').checked ? 1 : 0);
                finalCardsToDraw = Math.max(4, baseCards - reductions);
                additionalPasses = reductions;
                faction.passes = Math.min(2, basePasses + additionalPasses);

                messageDiv.textContent = `연합군 - 뽑을 카드: ${finalCardsToDraw} (턴: ${faction.currentTurn}, 기본: ${baseCards}, WIE 레벨: ${wieLevel}, 중국: ${document.getElementById('china-surrender').checked ? '항복' : '미항복'}, 인도: ${document.getElementById('india-surrender').checked ? '항복' : '미항복'}, 호주: ${document.getElementById('australia-surrender').checked ? '항복' : '미항복'}, 감소: ${reductions}, 패스: ${faction.passes})`;
                setTimeout(() => { messageDiv.textContent = ''; }, 5000);
            } else {
                const resourceHexes = Math.min(14, parseInt(document.getElementById('resource-hexes').value) || 0);
                const submarineSuccess = document.getElementById('submarine-success').checked ? 1 : 0;
                const bombingSuccesses = parseInt(document.getElementById('bombing-successes').value) || 0;
                reductions = submarineSuccess + Math.min(2, bombingSuccesses);

                if (faction.currentTurn === 1) {
                    baseCards = 2;
                    finalCardsToDraw = 2;
                } else if (faction.currentTurn >= 2 && faction.currentTurn <= 4) {
                    baseCards = 7;
                    finalCardsToDraw = 7;
                } else {
                    baseCards = Math.max(4, Math.ceil(resourceHexes / 2));
                    finalCardsToDraw = Math.max(4, baseCards - reductions);
                }

                faction.passes = faction.currentTurn === 1 ? 0 : finalCardsToDraw === 6 ? 1 : finalCardsToDraw <= 5 ? 2 : 0;

                messageDiv.textContent = `일본군 - 뽑을 카드: ${finalCardsToDraw} (턴: ${faction.currentTurn}, 기본: ${baseCards}, 잠수함전: ${submarineSuccess}, 폭격: ${bombingSuccesses}, 감소: ${reductions}, 패스: ${faction.passes})`;
                setTimeout(() => { messageDiv.textContent = ''; }, 5000);
            }

            passDisplay.textContent = `패스: ${faction.passes}`;
            alliedUsePassButton.disabled = faction.passes === 0;
            japaneseUsePassButton.disabled = faction.passes === 0;

            let cardsDrawn = 0;
            if (faction.currentTurn === 1 && factionType === 'allied') {
                faction.hand = [];
                cardsDrawn = 0;
            } else if (faction.currentTurn === 1) {
                const prefix = 'JP Card';
                faction.hand = faction.deck.filter(card => card.id === `${prefix} 1` || card.id === `${prefix} 2`);
                faction.deck = faction.deck.filter(card => card.id !== `${prefix} 1` && card.id !== `${prefix} 2`);
                cardsDrawn = faction.hand.length;
            } else {
                while (cardsDrawn < finalCardsToDraw) {
                    if (faction.deck.length === 0) {
                        if (faction.discardPile.length === 0) {
                            messageDiv.textContent = `뽑을 카드가 없습니다! (필요: ${finalCardsToDraw - cardsDrawn}장)`;
                            break;
                        }
                        faction.deck = faction.discardPile.slice();
                        faction.discardPile = [];
                        shuffle(faction.deck);
                        messageDiv.textContent = '버린 카드 더미를 섞는 중...';
                        setTimeout(() => { messageDiv.textContent = ''; }, 5000);
                        updateDiscardModal();
                    }
                    faction.hand.push(faction.deck.pop());
                    cardsDrawn++;
                }
            }

            updateHandDisplay();
            updateDeckRemainingDisplay();
            alliedDrawButton.disabled = faction.hand.length > 0 || (factionType === 'allied' && faction.currentTurn === 1);
            japaneseDrawButton.disabled = faction.hand.length > 0 && factionType === 'japanese';
            checkNextTurn();
        }

        alliedDrawButton.addEventListener('click', () => drawCards('allied'));
        japaneseDrawButton.addEventListener('click', () => drawCards('japanese'));

        alliedUsePassButton.addEventListener('click', () => usePass('allied'));
        japaneseUsePassButton.addEventListener('click', () => usePass('japanese'));

        function usePass(factionType) {
            const faction = factions[factionType];
            if (faction.passes > 0) {
                saveState();
                faction.passes--;
                passDisplay.textContent = `패스: ${faction.passes}`;
                alliedUsePassButton.disabled = faction.passes === 0;
                japaneseUsePassButton.disabled = faction.passes === 0;
                messageDiv.textContent = '패스를 사용했습니다!';
                setTimeout(() => { messageDiv.textContent = ''; }, 3000);
            }
        }

        nextTurnButton.addEventListener('click', () => {
            const faction = factions[currentFaction];
            if (faction.hand.length === 0) {
                saveState();
                nextTurnButton.style.background = '#5b5e60';
                nextTurnButton.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    nextTurnButton.style.background = '#6b6e70';
                    nextTurnButton.style.transform = 'scale(1)';
                }, 200);

                if (faction.currentTurn === 12) {
                    gameOverModal.textContent = '게임이 종료되었습니다!';
                    gameOverModal.style.display = 'block';
                    setTimeout(() => {
                        gameOverModal.style.display = 'none';
                        resetGame();
                    }, 3000);
                } else {
                    window.scrollTo(0, 0);
                    turnModal.textContent = `턴 ${faction.currentTurn + 1}로 넘어갑니다!`;
                    turnModal.style.display = 'block';
                    setTimeout(() => {
                        turnModal.style.display = 'none';
                    }, 2000);

                    faction.currentTurn++;
                    turnDisplay.textContent = `턴: ${faction.currentTurn}`;
                    alliedDrawButton.disabled = currentFaction === 'allied' && (faction.hand.length > 0 || faction.currentTurn === 1);
                    japaneseDrawButton.disabled = currentFaction === 'japanese' && faction.hand.length > 0;
                    faction.hand = [];
                    updateHandDisplay();
                    updateDeckRemainingDisplay();
                    updateUI();
                }
            }
        });

        undoButton.addEventListener('click', () => {
            undoButton.style.background = '#5b5e60';
            undoButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                undoButton.style.background = '#6b6e70';
                undoButton.style.transform = 'scale(1)';
            }, 200);
            undo();
        });

        restartButton.addEventListener('click', () => {
            restartButton.style.background = '#5b5e60';
            restartButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                restartButton.style.background = '#6b6e70';
                restartButton.style.transform = 'scale(1)';
            }, 200);
            resetGame();
        });

        function createCardElem(card, clickHandler) {
            const cardElem = document.createElement('div');
            cardElem.classList.add('card');
            const placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            placeholder.textContent = '이미지 로드 중...';
            cardElem.appendChild(placeholder);

            const img = document.createElement('img');
            img.alt = card.id;
            img.src = card.image;
            console.log(`이미지 로드 시도: ${card.id}, 경로: ${img.src}`);
            img.onerror = () => {
                img.src = placeholderImage;
                console.log(`이미지 로드 실패, 플레이스홀더 사용: ${card.id}, 경로: ${img.src}`);
            };
            img.onload = () => {
                cardElem.removeChild(placeholder);
                img.classList.add('loaded');
                cardElem.appendChild(img);
            };
            if (clickHandler) {
                cardElem.addEventListener('click', clickHandler);
            }
            return cardElem;
        }

        function updateHandDisplay() {
            handDiv.innerHTML = '';
            factions[currentFaction].hand.forEach((card, index) => {
                const cardElem = createCardElem(card, () => enlargeCard(index));
                handDiv.appendChild(cardElem);
            });
        }

        function updateFutureDisplay() {
            futureHandDiv.innerHTML = '';
            const faction = factions[currentFaction];
            if (faction.futureOffensive) {
                const cardElem = createCardElem(faction.futureOffensive, enlargeFutureCard);
                futureHandDiv.appendChild(cardElem);
            }
        }

        function updateDeckRemainingDisplay() {
            deckRemainingDiv.textContent = `남은 카드 더미: ${factions[currentFaction].deck.length}장`;
        }

        function updateDiscardModal() {
            discardModalContent.innerHTML = '';
            factions[currentFaction].discardPile.forEach((card, index) => {
                const cardElem = createCardElem(card, () => enlargeDiscardCard(index));
                discardModalContent.appendChild(cardElem);
            });
        }

        function updateRemovedModal() {
            removedModalContent.innerHTML = '';
            factions[currentFaction].removedCards.forEach((card, index) => {
                const cardElem = createCardElem(card, () => enlargeRemovedCard(index));
                removedModalContent.appendChild(cardElem);
            });
        }

        function enlargeCard(index) {
            if (enlargedCard) return;

            const faction = factions[currentFaction];
            const card = faction.hand[index];
            enlargedCard = document.createElement('div');
            enlargedCard.classList.add('enlarged');
            const placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            placeholder.textContent = '확대 이미지 로드 중...';
            enlargedCard.appendChild(placeholder);

            const img = document.createElement('img');
            img.alt = card.id;
            const basePath = card.image.substring(0, card.image.lastIndexOf('/'));
            const cardNumber = card.id.split(' ')[2];
            img.src = getValidImagePath(basePath, cardNumber, true);
            console.log(`확대 이미지 로드 시도: ${card.id}, 경로: ${img.src}`);
            img.onerror = () => {
                img.src = card.image;
                console.log(`확대 이미지 로드 실패, 원본 사용: ${card.id}, 경로: ${img.src}`);
            };
            img.onload = () => {
                enlargedCard.removeChild(placeholder);
                img.classList.add('loaded');
                enlargedCard.appendChild(img);
                document.body.appendChild(enlargedCard);
            };

            const buttonDiv = document.createElement('div');
            buttonDiv.classList.add('enlarged-buttons');

            if (currentFaction === 'japanese' && (card.id === 'JP Card 1' || card.id === 'JP Card 2')) {
                const removeButton = document.createElement('button');
                removeButton.textContent = '게임에서 제거 (3)';
                removeButton.addEventListener('click', () => {
                    saveState();
                    faction.removedCards.push(faction.hand.splice(index, 1)[0]);
                    closeEnlarged();
                    updateHandDisplay();
                    updateRemovedModal();
                    updateDeckRemainingDisplay();
                    checkNextTurn();
                });
                buttonDiv.appendChild(removeButton);

                const handleKeyPress = (e) => {
                    if (e.key === '3') {
                        removeButton.click();
                    }
                };
                document.addEventListener('keydown', handleKeyPress);

                enlargedCard.close = () => {
                    document.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('click', closeEnlargedOutside);
                    enlargedCard.remove();
                    enlargedCard = null;
                };
            } else {
                const useButton = document.createElement('button');
                useButton.textContent = '사용 (1)';
                useButton.addEventListener('click', () => {
                    saveState();
                    faction.discardPile.push(faction.hand.splice(index, 1)[0]);
                    updateDiscardModal();
                    closeEnlarged();
                    updateHandDisplay();
                    updateDeckRemainingDisplay();
                    checkNextTurn();
                });

                const futureButton = document.createElement('button');
                futureButton.textContent = '미래 공세 (2)';
                futureButton.disabled = !!faction.futureOffensive || [19, 20].includes(parseInt(card.id.split(' ')[2]));
                futureButton.addEventListener('click', () => {
                    if (!faction.futureOffensive) {
                        saveState();
                        faction.futureOffensive = faction.hand.splice(index, 1)[0];
                        updateFutureDisplay();
                        closeEnlarged();
                        updateHandDisplay();
                        updateDeckRemainingDisplay();
                        checkNextTurn();
                    }
                });

                const removeButton = document.createElement('button');
                removeButton.textContent = '게임에서 제거 (3)';
                removeButton.addEventListener('click', () => {
                    saveState();
                    faction.removedCards.push(faction.hand.splice(index, 1)[0]);
                    closeEnlarged();
                    updateHandDisplay();
                    updateRemovedModal();
                    updateDeckRemainingDisplay();
                    checkNextTurn();
                });

                buttonDiv.appendChild(useButton);
                buttonDiv.appendChild(futureButton);
                buttonDiv.appendChild(removeButton);

                const handleKeyPress = (e) => {
                    if (e.key === '1') {
                        useButton.click();
                    } else if (e.key === '2' && !futureButton.disabled) {
                        futureButton.click();
                    } else if (e.key === '3') {
                        removeButton.click();
                    }
                };
                document.addEventListener('keydown', handleKeyPress);

                enlargedCard.close = () => {
                    document.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('click', closeEnlargedOutside);
                    enlargedCard.remove();
                    enlargedCard = null;
                };
            }

            enlargedCard.appendChild(buttonDiv);

            setTimeout(() => {
                document.addEventListener('click', closeEnlargedOutside);
            }, 0);
        }

        function enlargeFutureCard() {
            if (enlargedCard) return;

            const faction = factions[currentFaction];
            const card = faction.futureOffensive;
            enlargedCard = document.createElement('div');
            enlargedCard.classList.add('enlarged');
            const placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            placeholder.textContent = '확대 이미지 로드 중...';
            enlargedCard.appendChild(placeholder);

            const img = document.createElement('img');
            img.alt = card.id;
            const basePath = card.image.substring(0, card.image.lastIndexOf('/'));
            const cardNumber = card.id.split(' ')[2];
            img.src = getValidImagePath(basePath, cardNumber, true);
            console.log(`확대 이미지 로드 시도: ${card.id}, 경로: ${img.src}`);
            img.onerror = () => {
                img.src = card.image;
                console.log(`확대 이미지 로드 실패, 원본 사용: ${card.id}, 경로: ${img.src}`);
            };
            img.onload = () => {
                enlargedCard.removeChild(placeholder);
                img.classList.add('loaded');
                enlargedCard.appendChild(img);
                document.body.appendChild(enlargedCard);
            };

            const buttonDiv = document.createElement('div');
            buttonDiv.classList.add('enlarged-buttons');

            const useButton = document.createElement('button');
            useButton.textContent = '사용 (1)';
            useButton.addEventListener('click', () => {
                saveState();
                faction.discardPile.push(faction.futureOffensive);
                faction.futureOffensive = null;
                updateFutureDisplay();
                updateDiscardModal();
                closeEnlarged();
                updateDeckRemainingDisplay();
                checkNextTurn();
            });

            buttonDiv.appendChild(useButton);
            enlargedCard.appendChild(buttonDiv);

            const handleKeyPress = (e) => {
                if (e.key === '1') {
                    useButton.click();
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            setTimeout(() => {
                document.addEventListener('click', closeEnlargedOutside);
            }, 0);

            enlargedCard.close = () => {
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('click', closeEnlargedOutside);
                enlargedCard.remove();
                enlargedCard = null;
            };
        }

        function enlargeDiscardCard(index) {
            if (enlargedCard) return;

            const faction = factions[currentFaction];
            const card = faction.discardPile[index];
            enlargedCard = document.createElement('div');
            enlargedCard.classList.add('enlarged');
            const placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            placeholder.textContent = '확대 이미지 로드 중...';
            enlargedCard.appendChild(placeholder);

            const img = document.createElement('img');
            img.alt = card.id;
            const basePath = card.image.substring(0, card.image.lastIndexOf('/'));
            const cardNumber = card.id.split(' ')[2];
            img.src = getValidImagePath(basePath, cardNumber, true);
            console.log(`확대 이미지 로드 시도: ${card.id}, 경로: ${img.src}`);
            img.onerror = () => {
                img.src = card.image;
                console.log(`확대 이미지 로드 실패, 원본 사용: ${card.id}, 경로: ${img.src}`);
            };
            img.onload = () => {
                enlargedCard.removeChild(placeholder);
                img.classList.add('loaded');
                enlargedCard.appendChild(img);
                document.body.appendChild(enlargedCard);
            };

            const buttonDiv = document.createElement('div');
            buttonDiv.classList.add('enlarged-buttons');

            const returnButton = document.createElement('button');
            returnButton.textContent = '카드 덱으로 다시 가져오기 (4)';
            returnButton.addEventListener('click', () => {
                saveState();
                faction.hand.push(faction.discardPile.splice(index, 1)[0]);
                updateHandDisplay();
                updateDiscardModal();
                updateDeckRemainingDisplay();
                closeEnlarged();
                messageDiv.textContent = '카드가 핸드에 추가되었습니다!';
                setTimeout(() => { messageDiv.textContent = ''; }, 3000);
            });

            buttonDiv.appendChild(returnButton);
            enlargedCard.appendChild(buttonDiv);

            const handleKeyPress = (e) => {
                if (e.key === '4') {
                    returnButton.click();
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            enlargedCard.close = () => {
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('click', closeEnlargedOutside);
                enlargedCard.remove();
                enlargedCard = null;
            };

            setTimeout(() => {
                document.addEventListener('click', closeEnlargedOutside);
            }, 0);
        }

        function enlargeRemovedCard(index) {
            if (enlargedCard) return;

            const faction = factions[currentFaction];
            const card = faction.removedCards[index];
            enlargedCard = document.createElement('div');
            enlargedCard.classList.add('enlarged');
            const placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            placeholder.textContent = '확대 이미지 로드 중...';
            enlargedCard.appendChild(placeholder);

            const img = document.createElement('img');
            img.alt = card.id;
            const basePath = card.image.substring(0, card.image.lastIndexOf('/'));
            const cardNumber = card.id.split(' ')[2];
            img.src = getValidImagePath(basePath, cardNumber, true);
            console.log(`확대 이미지 로드 시도: ${card.id}, 경로: ${img.src}`);
            img.onerror = () => {
                img.src = card.image;
                console.log(`확대 이미지 로드 실패, 원본 사용: ${card.id}, 경로: ${img.src}`);
            };
            img.onload = () => {
                enlargedCard.removeChild(placeholder);
                img.classList.add('loaded');
                enlargedCard.appendChild(img);
                document.body.appendChild(enlargedCard);
            };

            const buttonDiv = document.createElement('div');
            buttonDiv.classList.add('enlarged-buttons');

            const returnButton = document.createElement('button');
            returnButton.textContent = '카드 덱으로 다시 가져오기 (4)';
            returnButton.addEventListener('click', () => {
                saveState();
                faction.hand.push(faction.removedCards.splice(index, 1)[0]);
                updateHandDisplay();
                updateRemovedModal();
                updateDeckRemainingDisplay();
                closeEnlarged();
                messageDiv.textContent = '카드가 핸드에 추가되었습니다!';
                setTimeout(() => { messageDiv.textContent = ''; }, 3000);
            });

            buttonDiv.appendChild(returnButton);
            enlargedCard.appendChild(buttonDiv);

            const handleKeyPress = (e) => {
                if (e.key === '4') {
                    returnButton.click();
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            enlargedCard.close = () => {
                document.removeEventListener('keydown', handleKeyPress);
                document.removeEventListener('click', closeEnlargedOutside);
                enlargedCard.remove();
                enlargedCard = null;
            };

            setTimeout(() => {
                document.addEventListener('click', closeEnlargedOutside);
            }, 0);
        }

        function closeEnlarged() {
            if (enlargedCard) {
                enlargedCard.close();
            }
        }

        function closeEnlargedOutside(e) {
            if (!enlargedCard.contains(e.target)) {
                closeEnlarged();
            }
        }

        function checkNextTurn() {
            nextTurnButton.disabled = factions[currentFaction].hand.length > 0;
        }

        updateUI();
    </script>
</body>
</html>